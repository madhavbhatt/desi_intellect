__author__ = "Madhav"
import csv
import nmap
import sys
import os

hosts = dict()
ip_address = []
args = ""
file_name = "trash.csv"

if len(sys.argv) != 3:
    print "[*] Not like this Amigo. Give input and output file names..!!"
    print "[*] usage : %s <input_file> <output_file>" % sys.argv[0]
    sys.exit(-1)


with open(sys.argv[1], 'r') as fileA:
    firstLine = True
    reader = csv.reader(fileA, delimiter=',')
    for row in reader:
        if firstLine:  # skip first line
            firstLine = False
            continue
        if row[1] not in ip_address:
            ip_address.append(row[1])
            hosts[row[1]] = []
            hosts[row[1]].append(row[2])
        else:
            hosts[row[1]].append(row[2])


for key in hosts:
    nm = nmap.PortScanner()
    args = ""
    for port in hosts[key]:
        if len(hosts[key]) != 1:
            if port == hosts[key][0]:
                args += "-p" + port + ","
            elif port != hosts[key][-1]:
                args += port + ","
            else:
                args += port + " " + "-A -T4"
        else:
            args += "-p" + port + " " + "-A -T4"
    nm.scan(hosts=key, arguments=args)
    file_pointer = open(file_name, 'a')
    file_pointer.write(nm.csv())
    file_pointer.close()

q = open("trash.csv", "r")
z = open(sys.argv[2], "w")
r1 = csv.reader(q, delimiter=';')
with open("temp.csv", "w") as csv_file:
    writer = csv.writer(csv_file, delimiter=',')
    for row_str in r1:
        writer.writerow(row_str)


csv_file.close()


with open("temp.csv", "r") as csv_file:
    r2 = csv.reader(csv_file, delimiter=',')
    z.write("host,hostname,hostname_type,protocol,port,name,state,product,extrainfo,reason,version,conf,cpe\n")
    writer2 = csv.writer(z, delimiter=',')
    for row in r2:
        if row[0] != "host":
            writer2.writerow(row)


csv_file.close()
q.close()
z.close()
os.remove("trash.csv")
os.remove("temp.csv")
