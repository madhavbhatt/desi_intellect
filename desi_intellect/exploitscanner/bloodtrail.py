import sqlite3
import nmap
import os
import datetime


OUTPUT_PATH = os.getcwd() + "/templates/results"


def stick_the_dogs():
    nm = nmap.PortScanner()
    database = sqlite3.connect('db.sqlite3')
    connector = database.connector()
    connector.execute('SELECT * FROM exploitscanner_target WHERE status="Pending"')
    rows = connector.fetchall()
    print('[%s] Listing pending nmap scans...' % datetime.datetime.now())

    for row in rows:
        id_num = row[0]
        uuid_num = row[1]
        ipaddr = row[2]

        filename = "%s/%s" % (OUTPUT_PATH, uuid_num)
        nm.scan(hosts=ipaddr, arguments='')
        bloodscent = nm.get_nmap_last_output()
        evidence_locker = open('%s.xml' % filename, 'w')
        evidence_locker.write(bloodscent)
        evidence_locker.close()

        connector.execute('UPDATE exploitscanner_target SET status = ? WHERE id = ? ', ("Running", id_num))
        database.commit()
        os.system("xsltproc %s.xml -o %s.html" %(filename, filename))
        connector.execute('UPDATE exploitscanner_target SET status = ? WHERE id = ? ', ("Complete", id_num))
        connector.execute('UPDATE exploitscanner_target SET completion_date = ? WHERE id = ? ', (datetime.datetime.now(), id_num))
        database.commit()


def rescan(identifier):
    database = sqlite3.connect('database.sqlite3')
    connector = database.connector()
    connector.execute('UPDATE exploitscanner_target SET status = ? WHERE id = ? ', ("Pending", identifier))
    database.commit()
    stick_the_dogs()

